on:
  pull_request:
    branches:
      - 'develop'
      - 'main'
      - 'release/**'

env:
  isDevelop: ${{ startsWith(github.baseRef, 'refs/heads/develop') }}
  isRelease: ${{ startsWith(github.baseRef, 'refs/heads/release/') }}
  isHotfix: ${{ startsWith(github.baseRef, 'refs/heads/hotfix/') }}
  isMain: ${{ startsWith(github.baseRef, 'refs/heads/main') }}
  isCiCdTest: ${{ startsWith(github.baseRef, 'refs/heads/feature/ci-cd') }}
  canDeployOnDev: ${{ env.isDevelop || env.isHotfix || env.isCiCdTest }}
  canDeployOnQA: ${{ env.isDevelop || env.isHotfix || env.isRelease }}
  canDeployOnStaging: ${{ env.isHotfix || env.isRelease }}
  canDeployOnProduction: ${{ env.isHotfix || env.isRelease || env.isMaster }}

jobs:
  build:
    uses: ./.github/workflows/build.yml
  deployToDev:
    uses: ./.github/workflows/deploy.yml
    needs: [build]
    if: ${{ env.canDeployOnDev }}
    with:
      displayName: 'Deploy to Dev'
      environment: 'dev'
  deployToQa:
    uses: ./.github/workflows/deploy.yml
    needs: [build]
    if: ${{ env.canDeployOnQA }}
    with:
      displayName: 'Deploy to Dev'
      environment: 'qa'
  deployToStaging:
    uses: ./.github/workflows/deploy.yml
    needs: [build, deployToQa]
    if: ${{ env.canDeployOnStaging }}
    with:
      displayName: 'Deploy to Staging'
      environment: 'staging'
  deployToProduction:
    uses: ./.github/workflows/deploy.yml
    needs: [build, deployToStaging]
    if: ${{ env.canDeployOnProduction }}
    with:
      displayName: 'Deploy to Production'
      environment: 'prod'
